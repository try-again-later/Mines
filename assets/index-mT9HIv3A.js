(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(s){if(s.ep)return;s.ep=!0;const l=t(s);fetch(s.href,l)}})();const _={fps:30};class M{element;fps;startTime=new Date(0);stopTime=new Date(0);shouldStop=!0;stopped=Promise.resolve();constructor(e,t=_){this.element=e,this.element.textContent="0:000",this.fps=t.fps}setElementValue(e){const t=Math.floor(e/1e3),i=`${e%1e3}`.padStart(3,"0");this.element.textContent=`${t}:${i}`}async start(){this.startTime=new Date,this.shouldStop=!1,await this.stopped,this.stopped=new Promise(e=>{let t=0;const i=s=>{if(s-t>1e3/this.fps){t=s;const l=new Date().getTime()-this.startTime.getTime();this.setElementValue(l)}this.shouldStop?e():requestAnimationFrame(i)};requestAnimationFrame(i)})}async stop(){this.shouldStop=!0,this.stopTime=new Date,await this.stopped,this.setElementValue(this.finalMillisElapsed())}async reset(){await this.stop(),this.element.textContent="0:000"}finalMillisElapsed(){return this.stopTime.getTime()-this.startTime.getTime()}}function g(h,e){if(h==4)return`mine-neighbors-${e.neighborMineCount}`;switch(h){case 0:return"mine";case 1:return"mine-explosion";case 2:return"question-mark";case 3:return"flag-mark";default:throw h}}function p(h){const e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.classList.add("sprite");const i=document.createElementNS(e,"use");return i.setAttribute("href",`sprites.svg#${h}`),t.appendChild(i),t}var d=(h=>(h[h.Flag=0]="Flag",h[h.QuestionMark=1]="QuestionMark",h))(d||{});class v{constructor(e,t){this._x=e,this._y=t,this._element=document.createElement("div"),this._element.classList.add("cell"),this._element.dataset.x=e.toString(),this._element.dataset.y=t.toString(),this.contentElement=document.createElement("div"),this.contentElement.classList.add("cell-content"),this._element.appendChild(this.contentElement),this.coverElement=document.createElement("div"),this.coverElement.classList.add("cell-cover"),this.contentElement.appendChild(this.coverElement),this.markElement=null,this.spriteElement=null}neighborMineCount=0;hasMine=!1;_revealed=!1;_onReveal=()=>{};_mark=null;_onMarkChange=()=>{};_element;contentElement;coverElement;markElement;spriteElement;get x(){return this._x}get y(){return this._y}get element(){return this._element}get revealed(){return this._revealed}get mark(){return this._mark}set onReveal(e){this._onReveal=e}set onMarkChange(e){this._onMarkChange=e}addMark(e){switch(this._mark!=e&&this._onMarkChange(this,e),this._mark=e,this.markElement?.remove(),e){case 0:{const t=g(3);this.coverElement.appendChild(p(t)),this.markElement=this.coverElement.lastElementChild}break;case 1:{const t=g(2);this.coverElement.appendChild(p(t)),this.markElement=this.coverElement.lastElementChild}break}}hasMark(){return this._mark!=null}removeMark(){this._mark!=null&&this._onMarkChange(this,null),this._mark=null,this.markElement?.remove()}reveal(){this._onReveal(this),this._revealed=!0,this._mark=null}refreshSprite(){if(this.spriteElement?.remove(),this.hasMine){const e=g(0);this.contentElement.appendChild(p(e)),this.spriteElement=this.contentElement.lastElementChild}else if(this.neighborMineCount>0){const e=g(4,{neighborMineCount:this.neighborMineCount});this.contentElement.appendChild(p(e)),this.spriteElement=this.contentElement.lastElementChild}}explode(){if(this.hasMine){this.spriteElement?.remove();const e=g(1);this.contentElement.appendChild(p(e)),this.spriteElement=this.contentElement.lastElementChild}}animateReveal(e=0){this.element.classList.add("revealed"),this.coverElement.animate([{opacity:1,transform:"none"},{offset:.35,opacity:1,transform:"translate(0, -10%)"},{opacity:0,transform:"translate(0, -20%)"}],{fill:"forwards",duration:150,delay:e})}reset(){for(const e of this.coverElement.getAnimations())e.finish();this._revealed&&this.coverElement.animate([{opacity:0,transform:"none"},{opacity:1,transform:"none"}],{fill:"forwards",duration:0}),this.element.classList.remove("revealed"),this.spriteElement?.remove(),this.markElement?.remove(),this._revealed=!1,this._mark=null,this.hasMine=!1,this.neighborMineCount=0}}var f=(h=>(h[h.Left=0]="Left",h[h.Right=1]="Right",h[h.Both=2]="Both",h))(f||{});const k=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];class b{constructor(e,t){this._width=e,this._height=t,this.element=document.getElementById("game-field"),this.element.style.setProperty("--game-field-width",e.toString()),this.element.style.setProperty("--game-field-height",t.toString()),this._revealedCellCount=0,this.cells=[];for(let n=0;n<this._height;n+=1)for(let a=0;a<this._width;a+=1){const r=new v(a,n);this.cells.push(r),this.element.appendChild(r.element)}const i=[],s=(n,a)=>{const r=this.getCell(n,a);if(!r.hasMark()){r.revealed||(r.element.classList.add("active"),i.push(r));for(const m of this.getNeighbors(r))!m.revealed&&m.mark==null&&(m.element.classList.add("active"),i.push(m))}},l=()=>{for(const n of i)n.element.classList.remove("active");i.length=0};let o=!1,c=!1;this.element.addEventListener("mousedown",n=>{if(n.preventDefault(),n.button==0&&(o=!0),n.button==2&&(c=!0),o&&c&&n.target instanceof HTMLElement&&n.target.classList.contains("cell")){const a=Number.parseInt(n.target.dataset.x),r=Number.parseInt(n.target.dataset.y);s(a,r)}}),this.element.addEventListener("mouseup",n=>{if(n.button!=0&&n.button!=2)return;l();let a=null;if(o&&c?a=f.Both:o?a=f.Left:c&&(a=f.Right),a!=null&&n.target instanceof HTMLElement&&n.target.classList.contains("cell")){const r=Number.parseInt(n.target.dataset.x),m=Number.parseInt(n.target.dataset.y),u=this.getCell(r,m);this._onCellClick(u,a)}o=!1,c=!1}),this.element.addEventListener("mouseover",n=>{if(o&&c&&n.target instanceof HTMLElement&&n.target.classList.contains("cell")){l();const a=Number.parseInt(n.target.dataset.x),r=Number.parseInt(n.target.dataset.y);s(a,r)}}),this.element.addEventListener("mouseleave",n=>{n.target==this.element&&(l(),o=!1,c=!1)}),this.element.addEventListener("contextmenu",n=>{n.preventDefault()})}element;_revealedCellCount;cells;_onCellClick=()=>{};_onCellReveal=()=>{};_onCellMarkChange=()=>{};get width(){return this._width}get height(){return this._height}get revealedCellCount(){return this._revealedCellCount}set onCellMarkChange(e){this._onCellMarkChange=e;for(const t of this.cells)t.onMarkChange=e}set onCellReveal(e){this._onCellReveal=e;for(const t of this.cells)t.onReveal=e}set onCellClick(e){this._onCellClick=e}getCell(e,t){const i=this.cells[t*this._width+e];if(i==null)throw new Error("Cell coordinatesa are out of bounds.");return i}cellIndex(e){return e.y*this._width+e.x}*getNeighbors(e){for(const[t,i]of k)e.x+t<0||e.x+t>=this._width||e.y+i<0||e.y+i>=this._height||(yield this.getCell(e.x+t,e.y+i))}fillWithMines(e){if(e>this._width*this._height)throw new Error("Too many mines for the current game field size.");const t=[];for(let i=0;i<this._width*this._height;i+=1)t.push(i);for(let i=0;i<e;i+=1){let s=Math.floor(Math.random()*t.length);const l=this.cells[t[s]];l.hasMine=!0;for(const o of this.getNeighbors(l))o.neighborMineCount+=1;t[s]=t[t.length-1],t.pop()}for(const i of this.cells)i.refreshSprite()}reveal(e,t){const i=this.getCell(e,t);if(!i.revealed)if(i.hasMine||i.neighborMineCount>0)i.reveal(),i.animateReveal(),this._revealedCellCount+=1;else{const s=new Set,l=new Map,o=[i];l.set(this.cellIndex(i),0);let c=0;for(;o.length>0;){const n=o.length;for(let a=0;a<n;a+=1){const r=o.shift();r.reveal(),this._revealedCellCount+=1;const m=l.get(this.cellIndex(r));if(r.animateReveal(Math.min(m,100)*15),r.neighborMineCount==0)for(const u of this.getNeighbors(r)){const C=this.cellIndex(u);!s.has(C)&&!u.revealed&&(s.add(C),l.set(C,c+1),o.push(u))}}c+=1}}}revealAll(){for(const e of this.cells)e.revealed||e.animateReveal(),e.reveal();this._revealedCellCount=this._width*this._height}reset(){for(const e of this.cells)e.reset();this._revealedCellCount=0}setSize(e,t){this._width=e,this._height=t,this.element.style.setProperty("--game-field-width",this._width.toString()),this.element.style.setProperty("--game-field-height",this._height.toString());for(const i of this.cells)i.element.remove();this._revealedCellCount=0,this.cells.splice(0,this.cells.length);for(let i=0;i<this._height;i+=1)for(let s=0;s<this._width;s+=1){const l=new v(s,i);this.cells.push(l),l.onMarkChange=this._onCellMarkChange,l.onReveal=this._onCellReveal,this.element.appendChild(l.element)}}}function E(h,e,t){return Math.min(Math.max(h,e),t)}const y={easy:Object.freeze({kind:"easy",fieldWidth:9,fieldHeight:9,mineCount:10}),medium:Object.freeze({kind:"medium",fieldWidth:16,fieldHeight:16,mineCount:40}),hard:Object.freeze({kind:"hard",fieldWidth:30,fieldHeight:16,mineCount:99})},D=9,L=9,w=10,I=100,S=100;class F{element;visible=!1;currentDifficulty;selectedDifficulty;_onDifficultyChange=()=>{};constructor(){this.element=document.getElementById("difficulty-selection");const e=document.getElementById("difficulty-selection-button");e.addEventListener("click",this.toggle.bind(this)),document.addEventListener("click",t=>{t.target!=e&&!this.element.contains(t.target)&&this.close()}),this.currentDifficulty=y.easy,this.selectedDifficulty=this.currentDifficulty,this.render(),this.element.addEventListener("change",t=>{if(!(t.target instanceof HTMLInputElement))return;let i=null;if("difficultyInput"in t.target.dataset){const s=t.target.value;s=="custom"?i={kind:"custom",fieldWidth:Number.parseInt(this.widthInputElement.value),fieldHeight:Number.parseInt(this.heightInputElement.value),mineCount:Number.parseInt(this.minesInputElement.value)}:i=y[s]}else"customDifficultySettings"in t.target.dataset?i={kind:"custom",fieldWidth:Number.parseInt(this.widthInputElement.value),fieldHeight:Number.parseInt(this.heightInputElement.value),mineCount:Number.parseInt(this.minesInputElement.value)}:i=y.easy;this.selectedDifficulty=i,this.render()}),this.element.querySelector("[data-cancel]").addEventListener("click",()=>{this.close()}),this.element.querySelector("[data-confirm]").addEventListener("click",()=>{this.selectedDifficulty.kind=="custom"&&(this.selectedDifficulty.fieldWidth=E(this.selectedDifficulty.fieldWidth,1,I),this.selectedDifficulty.fieldHeight=E(this.selectedDifficulty.fieldHeight,1,S),this.selectedDifficulty.mineCount=Math.min(this.selectedDifficulty.mineCount,this.selectedDifficulty.fieldWidth*this.selectedDifficulty.fieldHeight)),(this.currentDifficulty.fieldWidth!=this.selectedDifficulty.fieldWidth||this.currentDifficulty.fieldHeight!=this.selectedDifficulty.fieldHeight||this.currentDifficulty.mineCount!=this.selectedDifficulty.mineCount)&&this._onDifficultyChange(this.selectedDifficulty.fieldWidth,this.selectedDifficulty.fieldHeight,this.selectedDifficulty.mineCount),this.currentDifficulty=this.selectedDifficulty,this.close()})}set onDifficultyChange(e){this._onDifficultyChange=e}get difficulty(){return this.currentDifficulty}render(){this.element.querySelector(`[value=${this.selectedDifficulty.kind}]`).checked=!0,this.selectedDifficulty.kind=="custom"?(this.widthInputElement.value=this.selectedDifficulty.fieldWidth.toString(),this.heightInputElement.value=this.selectedDifficulty.fieldHeight.toString(),this.minesInputElement.value=this.selectedDifficulty.mineCount.toString()):(this.widthInputElement.value=D.toString(),this.heightInputElement.value=L.toString(),this.minesInputElement.value=w.toString()),this.widthInputElement.disabled=this.selectedDifficulty.kind!="custom",this.heightInputElement.disabled=this.selectedDifficulty.kind!="custom",this.minesInputElement.disabled=this.selectedDifficulty.kind!="custom"}open(){this.selectedDifficulty=this.currentDifficulty,this.render(),this.element.classList.remove("cloak"),this.element.classList.add("difficulty-selection-popup--visible"),this.visible=!0}close(){this.element.classList.remove("difficulty-selection-popup--visible"),this.visible=!1}toggle(){this.visible?this.close():this.open()}get widthInputElement(){return this.element.querySelector("[name=width]")}get heightInputElement(){return this.element.querySelector("[name=height]")}get minesInputElement(){return this.element.querySelector("[name=mines]")}}class x{state;width;height;mineCount;minesLeft;minesLeftElement;timer;gameField;constructor(){this.state=0,this.width=9,this.height=9,this.mineCount=10,this.minesLeft=this.mineCount,this.minesLeftElement=document.getElementById("mines-left"),this.setMinesLeft(this.mineCount),this.timer=new M(document.getElementById("game-timer")),this.gameField=new b(this.width,this.height),this.gameField.fillWithMines(this.mineCount),this.gameField.onCellMarkChange=(t,i)=>{t.mark===d.Flag&&this.setMinesLeft(this.minesLeft+1),i===d.Flag&&this.setMinesLeft(this.minesLeft-1)},this.gameField.onCellReveal=t=>{t.mark===d.Flag&&!t.hasMine&&this.setMinesLeft(this.minesLeft+1),t.mark===null&&t.hasMine&&this.setMinesLeft(this.minesLeft-1)},this.gameField.onCellClick=(t,i)=>{switch(i){case f.Left:this.leftMouseButtonClick(t);break;case f.Right:this.rightMouseButtonClick(t);break;case f.Both:this.bothMouseButtonsClick(t);break}};const e=new F;e.onDifficultyChange=(t,i,s)=>{this.width=t,this.height=i,this.mineCount=s,this.gameField.setSize(t,i),this.reset()}}setMinesLeft(e){this.minesLeft=e,this.minesLeftElement.textContent=e.toString()}reveal(e){if(this.state===0&&(this.timer.start(),this.state=1),e.hasMine){this.state=3,this.timer.stop(),this.gameField.revealAll();for(const t of this.gameField.cells)t.explode()}else{this.gameField.reveal(e.x,e.y);const t=this.gameField.width*this.gameField.height;this.gameField.revealedCellCount+this.mineCount===t&&(this.state=2,this.timer.stop(),this.gameField.revealAll())}}leftMouseButtonClick(e){if(!e.revealed){if(e.hasMark())return;this.reveal(e)}}rightMouseButtonClick(e){e.revealed||(e.hasMark()?e.mark===d.Flag?e.addMark(d.QuestionMark):e.removeMark():e.addMark(d.Flag))}bothMouseButtonsClick(e){if(!e.revealed)this.leftMouseButtonClick(e);else{let t=0;for(const i of this.gameField.getNeighbors(e))i.mark===d.Flag&&(t+=1);if(t===e.neighborMineCount)for(const i of this.gameField.getNeighbors(e))!i.revealed&&i.mark!==d.Flag&&this.reveal(i)}}reset(){this.gameField.reset(),this.gameField.fillWithMines(this.mineCount),this.timer.reset(),this.state=0,this.setMinesLeft(this.mineCount)}}const T=new x,N=document.getElementById("new-game-button");N.addEventListener("click",()=>{T.reset()});
